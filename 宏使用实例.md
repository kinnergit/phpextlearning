# 宏使用实例
[TOC]

## PHP_FUNCTION, PHP_METHOD, PHP_FE, etc.
```c
// main/php.h
#define PHP_FUNCTION			ZEND_FUNCTION
#define PHP_METHOD  			ZEND_METHOD
#define PHP_FE			ZEND_FE
#define PHP_FE_END      ZEND_FE_END

// Zend/zend.h
//形参
#define INTERNAL_FUNCTION_PARAMETERS zend_execute_data *execute_data, zval *return_value
//实参
#define INTERNAL_FUNCTION_PARAM_PASSTHRU execute_data, return_value

// Zend/zend_API.h
#define ZEND_FN(name) zif_##name
#define ZEND_MN(name) zim_##name
#define ZEND_NAMED_FUNCTION(name)		void name(INTERNAL_FUNCTION_PARAMETERS)
#define ZEND_FUNCTION(name)				ZEND_NAMED_FUNCTION(ZEND_FN(name))
#define ZEND_METHOD(classname, name)	ZEND_NAMED_FUNCTION(ZEND_MN(classname##_##name))

#define ZEND_FENTRY(zend_name, name, arg_info, flags)	{ #zend_name, name, arg_info, (uint32_t) (sizeof(arg_info)/sizeof(struct _zend_internal_arg_info)-1), flags },

#define ZEND_FE(name, arg_info)						ZEND_FENTRY(name, ZEND_FN(name), arg_info, 0)
#define ZEND_FE_END            { NULL, NULL, NULL, 0, 0 }

// Zend/zend_compile.h
/* arg_info for internal functions */
typedef struct _zend_internal_arg_info {
	const char *name;				// 变量名
	const char *class_name;			// 类名
	zend_uchar type_hint; 			// 类型提示
	zend_uchar pass_by_reference;	// 引用传值
	zend_bool allow_null; 			// 是否允许NULL值
	zend_bool is_variadic; 			// 是否为可变参数列表
} zend_internal_arg_info;
```

---

**C Code**

```c
PHP_FUNCTION(k1_func);
//以上宏展开后
void zif_k1_func(zend_execute_data *execute_data, zval *return_value);

PHP_METHOD(KClass, k1_func);
//以上宏展开后
void zim_KClass_k1_func(zend_execute_data *execute_data, zval *return_value);

PHP_FE(k1_func, NULL)
//以上宏展开后
{ "k1_func", zif_k1_func, NULL, (uint32_t) (sizeof(NULL)/sizeof(struct _zend_internal_arg_info)-1), 0 },

PHP_FE_END
//以上宏展开后
{ NULL, NULL, NULL, 0, 0 }
```

## PHP_MINIT_FUNCTION, PHP_MSHUTDOWN_FUNCTION, PHP_RINIT_FUNCTION, PHP_RSHUTDOWN_FUNCTION, PHP_MINFO_FUNCTION

```c
// main/php.h
/* Compatibility macros */
#define PHP_MINIT_FUNCTION		ZEND_MODULE_STARTUP_D
#define PHP_MSHUTDOWN_FUNCTION	ZEND_MODULE_SHUTDOWN_D
#define PHP_RINIT_FUNCTION		ZEND_MODULE_ACTIVATE_D
#define PHP_RSHUTDOWN_FUNCTION	ZEND_MODULE_DEACTIVATE_D
#define PHP_MINFO_FUNCTION		ZEND_MODULE_INFO_D

// Zend/zend_API.h
/* Name macros */
#define ZEND_MODULE_STARTUP_N(module)       zm_startup_##module
#define ZEND_MODULE_SHUTDOWN_N(module)		zm_shutdown_##module
#define ZEND_MODULE_ACTIVATE_N(module)		zm_activate_##module
#define ZEND_MODULE_DEACTIVATE_N(module)	zm_deactivate_##module
#define ZEND_MODULE_INFO_N(module)			zm_info_##module

/* Declaration macros */
#define ZEND_MODULE_STARTUP_D(module)		int ZEND_MODULE_STARTUP_N(module)(INIT_FUNC_ARGS)
#define ZEND_MODULE_SHUTDOWN_D(module)		int ZEND_MODULE_SHUTDOWN_N(module)(SHUTDOWN_FUNC_ARGS)
#define ZEND_MODULE_ACTIVATE_D(module)		int ZEND_MODULE_ACTIVATE_N(module)(INIT_FUNC_ARGS)
#define ZEND_MODULE_DEACTIVATE_D(module)	int ZEND_MODULE_DEACTIVATE_N(module)(SHUTDOWN_FUNC_ARGS)
#define ZEND_MODULE_INFO_D(module)			void ZEND_MODULE_INFO_N(module)(ZEND_MODULE_INFO_FUNC_ARGS)

#define INIT_FUNC_ARGS		int type, int module_number
#define INIT_FUNC_ARGS_PASSTHRU	type, module_number

#define SHUTDOWN_FUNC_ARGS	int type, int module_number
#define SHUTDOWN_FUNC_ARGS_PASSTHRU type, module_number

#define ZEND_MODULE_INFO_FUNC_ARGS zend_module_entry *zend_module
#define ZEND_MODULE_INFO_FUNC_ARGS_PASSTHRU zend_module
```

---

**C Code :**

```c
PHP_MINIT_FUNCTION(k1);
//以上宏展开为
int zm_startup_k1(int type, int module_number);

PHP_MSHUTDOWN_FUNCTION(k1);
//以上宏展开为
int zm_shutdown_k1(int type, int module_number);

PHP_RINIT_FUNCTION(k1);
//以上宏展开为
int zm_activate_k1(int type, int module_number);

PHP_RSHUTDOWN_FUNCTION(k1);
//以上宏展开为
int zm_deactivate_k1(int type, int module_number);

PHP_MINFO_FUNCTION(k1);
//以上宏展开为
void zm_info_k1(zend_module_entry *zend_module);
```

## zend_hash_num_elements

```c
// Zend/zend_hash.h
#define zend_hash_num_elements(ht) (ht)->nNumOfElements
```

---

**C Code :**

```c
/* {{{ proto k1_func(array $arr) : int
   Count the number of elements in a an array. */
PHP_FUNCTION(k1_func)
{
    zval *arr;

    ZEND_PARSE_PARAMETERS_START(1, 1)
        Z_PARAM_ARRAY(arr)
    ZEND_PARSE_PARAMETERS_END();

    RETURN_LONG(zend_hash_num_elements(Z_ARRVAL_P(arr)));
}
/* }}} */
```

**PHP Code :**

```php
<?php
$arr = [1, 2, 'name' => 'Kinner'];

$count = k1_func($arr);

var_dump($count);
?>
```

**Output :**

```shell
int(3)
```


