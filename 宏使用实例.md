# 宏使用实例
[TOC]

## PHP_FUNCTION, PHP_METHOD, PHP_FE, etc.
```c
// main/php.h
#define PHP_FUNCTION			ZEND_FUNCTION
#define PHP_METHOD  			ZEND_METHOD
#define PHP_FE			ZEND_FE
#define PHP_FE_END      ZEND_FE_END

// Zend/zend.h
//形参
#define INTERNAL_FUNCTION_PARAMETERS zend_execute_data *execute_data, zval *return_value
//实参
#define INTERNAL_FUNCTION_PARAM_PASSTHRU execute_data, return_value

// Zend/zend_API.h
#define ZEND_FN(name) zif_##name
#define ZEND_MN(name) zim_##name
#define ZEND_NAMED_FUNCTION(name)		void name(INTERNAL_FUNCTION_PARAMETERS)
#define ZEND_FUNCTION(name)				ZEND_NAMED_FUNCTION(ZEND_FN(name))
#define ZEND_METHOD(classname, name)	ZEND_NAMED_FUNCTION(ZEND_MN(classname##_##name))

#define ZEND_FENTRY(zend_name, name, arg_info, flags)	{ #zend_name, name, arg_info, (uint32_t) (sizeof(arg_info)/sizeof(struct _zend_internal_arg_info)-1), flags },

#define ZEND_FE(name, arg_info)						ZEND_FENTRY(name, ZEND_FN(name), arg_info, 0)
#define ZEND_FE_END            { NULL, NULL, NULL, 0, 0 }

// Zend/zend_compile.h
/* arg_info for internal functions */
typedef struct _zend_internal_arg_info {
	const char *name;				// 变量名
	const char *class_name;			// 类名
	zend_uchar type_hint; 			// 类型提示
	zend_uchar pass_by_reference;	// 引用传值
	zend_bool allow_null; 			// 是否允许NULL值
	zend_bool is_variadic; 			// 是否为可变参数列表
} zend_internal_arg_info;
```

---

**C Code**

```c
PHP_FUNCTION(k1_func);
//以上宏展开后
void zif_k1_func(zend_execute_data *execute_data, zval *return_value);

PHP_METHOD(KClass, k1_func);
//以上宏展开后
void zim_KClass_k1_func(zend_execute_data *execute_data, zval *return_value);

PHP_FE(k1_func, NULL)
//以上宏展开后
{ "k1_func", zif_k1_func, NULL, (uint32_t) (sizeof(NULL)/sizeof(struct _zend_internal_arg_info)-1), 0 },

PHP_FE_END
//以上宏展开后
{ NULL, NULL, NULL, 0, 0 }
```

## PHP_MINIT_FUNCTION, PHP_MSHUTDOWN_FUNCTION, PHP_RINIT_FUNCTION, PHP_RSHUTDOWN_FUNCTION, PHP_MINFO_FUNCTION

```c
// main/php.h
/* Compatibility macros */
#define PHP_MINIT_FUNCTION		ZEND_MODULE_STARTUP_D
#define PHP_MSHUTDOWN_FUNCTION	ZEND_MODULE_SHUTDOWN_D
#define PHP_RINIT_FUNCTION		ZEND_MODULE_ACTIVATE_D
#define PHP_RSHUTDOWN_FUNCTION	ZEND_MODULE_DEACTIVATE_D
#define PHP_MINFO_FUNCTION		ZEND_MODULE_INFO_D

// Zend/zend_API.h
/* Name macros */
#define ZEND_MODULE_STARTUP_N(module)       zm_startup_##module
#define ZEND_MODULE_SHUTDOWN_N(module)		zm_shutdown_##module
#define ZEND_MODULE_ACTIVATE_N(module)		zm_activate_##module
#define ZEND_MODULE_DEACTIVATE_N(module)	zm_deactivate_##module
#define ZEND_MODULE_INFO_N(module)			zm_info_##module

/* Declaration macros */
#define ZEND_MODULE_STARTUP_D(module)		int ZEND_MODULE_STARTUP_N(module)(INIT_FUNC_ARGS)
#define ZEND_MODULE_SHUTDOWN_D(module)		int ZEND_MODULE_SHUTDOWN_N(module)(SHUTDOWN_FUNC_ARGS)
#define ZEND_MODULE_ACTIVATE_D(module)		int ZEND_MODULE_ACTIVATE_N(module)(INIT_FUNC_ARGS)
#define ZEND_MODULE_DEACTIVATE_D(module)	int ZEND_MODULE_DEACTIVATE_N(module)(SHUTDOWN_FUNC_ARGS)
#define ZEND_MODULE_INFO_D(module)			void ZEND_MODULE_INFO_N(module)(ZEND_MODULE_INFO_FUNC_ARGS)

#define INIT_FUNC_ARGS		int type, int module_number
#define INIT_FUNC_ARGS_PASSTHRU	type, module_number

#define SHUTDOWN_FUNC_ARGS	int type, int module_number
#define SHUTDOWN_FUNC_ARGS_PASSTHRU type, module_number

#define ZEND_MODULE_INFO_FUNC_ARGS zend_module_entry *zend_module
#define ZEND_MODULE_INFO_FUNC_ARGS_PASSTHRU zend_module
```

---

**C Code :**

```c
PHP_MINIT_FUNCTION(k1);
//以上宏展开为
int zm_startup_k1(int type, int module_number);

PHP_MSHUTDOWN_FUNCTION(k1);
//以上宏展开为
int zm_shutdown_k1(int type, int module_number);

PHP_RINIT_FUNCTION(k1);
//以上宏展开为
int zm_activate_k1(int type, int module_number);

PHP_RSHUTDOWN_FUNCTION(k1);
//以上宏展开为
int zm_deactivate_k1(int type, int module_number);

PHP_MINFO_FUNCTION(k1);
//以上宏展开为
void zm_info_k1(zend_module_entry *zend_module);
```

## zend_hash_num_elements

```c
// Zend/zend_hash.h
#define zend_hash_num_elements(ht) (ht)->nNumOfElements
```

---

**C Code :**

```c
/* {{{ proto k1_func(array $arr) : int
   Count the number of elements in a an array. */
PHP_FUNCTION(k1_func)
{
    zval *arr;

    ZEND_PARSE_PARAMETERS_START(1, 1)
        Z_PARAM_ARRAY(arr)
    ZEND_PARSE_PARAMETERS_END();

    RETURN_LONG(zend_hash_num_elements(Z_ARRVAL_P(arr)));
}
/* }}} */
```

**PHP Code :**

```php
<?php
$arr = [1, 2, 'name' => 'Kinner'];

$count = k1_func($arr);

var_dump($count);
?>
```

**Output :**

```shell
int(3)
```

## Global Variable

```c
全局变量的使用
```

---

**C Code :**

```c
// ext/k1/php_k1.h
/*
  	Declare any global variables you may need between the BEGIN
	and END macros here:
*/

ZEND_BEGIN_MODULE_GLOBALS(k1)
zend_long  global_value;
char *global_string;
ZEND_END_MODULE_GLOBALS(k1)

// ext/k1/k1.c
/* If you declare any globals in php_k1.h uncomment this:
*/

ZEND_DECLARE_MODULE_GLOBALS(k1)

/* {{{ PHP_INI
 */
/* Remove comments and fill if you need to have entries in php.ini
*/
PHP_INI_BEGIN()
				STD_PHP_INI_ENTRY("k1.global_value",      "110", PHP_INI_ALL, OnUpdateLong, global_value, zend_k1_globals, k1_globals)
				STD_PHP_INI_ENTRY("k1.global_string", "Hi, global string", PHP_INI_ALL, OnUpdateString, global_string, zend_k1_globals, k1_globals)
PHP_INI_END()
/* }}} */

/* {{{ php_k1_init_globals
 */
/* Uncomment this function if you have INI entries
*/

static void php_k1_init_globals(zend_k1_globals *k1_globals)
{
	k1_globals->global_value = 0;
	k1_globals->global_string = NULL;
}
/* }}} */

/* {{{ PHP_MINIT_FUNCTION
 */
PHP_MINIT_FUNCTION(k1)
{
	/* If you have INI entries, uncomment these lines
	*/

	REGISTER_INI_ENTRIES();

	return SUCCESS;
}
/* }}} */

/* {{{ PHP_MSHUTDOWN_FUNCTION
 */
PHP_MSHUTDOWN_FUNCTION(k1)
{
	/* uncomment this line if you have INI entries
	*/

	UNREGISTER_INI_ENTRIES();

	return SUCCESS;
}
/* }}} */

/* {{{ PHP_MINFO_FUNCTION
 */
PHP_MINFO_FUNCTION(k1)
{
	php_info_print_table_start();
	php_info_print_table_header(2, "k1 support", "enabled");
	php_info_print_table_end();

	/* Remove comments if you have entries in php.ini
	*/

	DISPLAY_INI_ENTRIES();
}
/* }}} */

/* {{{ k1_module_entry
 */
zend_module_entry k1_module_entry = {
	STANDARD_MODULE_HEADER,
	"k1",
	k1_functions,
	PHP_MINIT(k1),
	PHP_MSHUTDOWN(k1),
	PHP_RINIT(k1),		/* Replace with NULL if there's nothing to do at request start */
	PHP_RSHUTDOWN(k1),	/* Replace with NULL if there's nothing to do at request end */
	PHP_MINFO(k1),
	PHP_K1_VERSION,
	PHP_MODULE_GLOBALS(k1), //模块全局变量
	NULL,
	NULL,
	NULL,
	STANDARD_MODULE_PROPERTIES_EX
};
/* }}} */
```

**PHP Code :**

```php
<?php
//输出ini全局变量
echo 'global_value ini: ', ini_get('k1.global_value'), PHP_EOL;
echo 'global_string ini: ', ini_get('k1.global_string'), PHP_EOL;
?>
```

**Output :**

```shell
global_value ini: 110
global_string ini: Hi, Kinner Global String
```

## REGISTER_*_CONSTANT（普通常量）

```c
// Zend/zend_constants.h
#define REGISTER_NULL_CONSTANT(name, flags)  zend_register_null_constant((name), sizeof(name)-1, (flags), module_number)

#define REGISTER_BOOL_CONSTANT(name, bval, flags)  zend_register_bool_constant((name), sizeof(name)-1, (bval), (flags), module_number)

#define REGISTER_LONG_CONSTANT(name, lval, flags)  zend_register_long_constant((name), sizeof(name)-1, (lval), (flags), module_number)

#define REGISTER_DOUBLE_CONSTANT(name, dval, flags)  zend_register_double_constant((name), sizeof(name)-1, (dval), (flags), module_number)

#define REGISTER_STRING_CONSTANT(name, str, flags)  zend_register_string_constant((name), sizeof(name)-1, (str), (flags), module_number)

#define REGISTER_STRINGL_CONSTANT(name, str, len, flags)  zend_register_stringl_constant((name), sizeof(name)-1, (str), (len), (flags), module_number)
```

---

**C Code :**

```c
// ext/k1/k1.c
/* {{{ PHP_MINIT_FUNCTION
 */
PHP_MINIT_FUNCTION(k1)
{
	/* If you have INI entries, uncomment these lines
	REGISTER_INI_ENTRIES();
	*/
	
	/*
	 * 模块初始化时注册常量
	 */
	REGISTER_LONG_CONSTANT("K1_CONST_LONG", 110, CONST_CS | CONST_PERSISTENT);
	REGISTER_STRING_CONSTANT("K1_CONST_STRING", "Hi, const string", CONST_CS | CONST_PERSISTENT);
	REGISTER_DOUBLE_CONSTANT("K1_CONST_FLOAT", 3.14, CONST_CS | CONST_PERSISTENT);
	REGISTER_BOOL_CONSTANT("K1_CONST_TRUE", (zend_bool)1, CONST_CS | CONST_PERSISTENT);
	REGISTER_NULL_CONSTANT("K1_CONST_NULL", CONST_CS | CONST_PERSISTENT);

	return SUCCESS;
}
/* }}} */
```

**PHP Code :**

```php
<?php
echo 'K1_CONST_LONG: ', var_dump(K1_CONST_LONG);
echo 'K1_CONST_STRING: ', var_dump(K1_CONST_STRING);
echo 'K1_CONST_FLOAT: ', var_dump(K1_CONST_FLOAT);
echo 'K1_CONST_TRUE: ', var_dump(K1_CONST_TRUE);
echo 'K1_CONST_NULL: ', var_dump(K1_CONST_NULL);
?>
```

**Output :**

```shell
K1_CONST_LONG: int(110)
K1_CONST_STRING: string(16) "Hi, const string"
K1_CONST_FLOAT: float(3.14)
K1_CONST_TRUE: bool(true)
K1_CONST_NULL: NULL
```

## REGISTER_NS_*_CONSTANT（命名空间常量）

```c
// Zend/zend_constants.h
#define REGISTER_NS_NULL_CONSTANT(ns, name, flags)  zend_register_null_constant(ZEND_NS_NAME(ns, name), sizeof(ZEND_NS_NAME(ns, name))-1, (flags), module_number)

#define REGISTER_NS_BOOL_CONSTANT(ns, name, bval, flags)  zend_register_bool_constant(ZEND_NS_NAME(ns, name), sizeof(ZEND_NS_NAME(ns, name))-1, (bval), (flags), module_number)

#define REGISTER_NS_LONG_CONSTANT(ns, name, lval, flags)  zend_register_long_constant(ZEND_NS_NAME(ns, name), sizeof(ZEND_NS_NAME(ns, name))-1, (lval), (flags), module_number)

#define REGISTER_NS_DOUBLE_CONSTANT(ns, name, dval, flags)  zend_register_double_constant(ZEND_NS_NAME(ns, name), sizeof(ZEND_NS_NAME(ns, name))-1, (dval), (flags), module_number)

#define REGISTER_NS_STRING_CONSTANT(ns, name, str, flags)  zend_register_string_constant(ZEND_NS_NAME(ns, name), sizeof(ZEND_NS_NAME(ns, name))-1, (str), (flags), module_number)

#define REGISTER_NS_STRINGL_CONSTANT(ns, name, str, len, flags)  zend_register_stringl_constant(ZEND_NS_NAME(ns, name), sizeof(ZEND_NS_NAME(ns, name))-1, (str), (len), (flags), module_number)

```

---

**C Code :**

```c
/* {{{ PHP_MINIT_FUNCTION
 */
PHP_MINIT_FUNCTION(k1)
{
	/* If you have INI entries, uncomment these lines
	REGISTER_INI_ENTRIES();
	*/	

	/*
	 * 注册常量
	 */
	REGISTER_NS_LONG_CONSTANT("k1", "K1_CONST_LONG", 110, CONST_CS | CONST_PERSISTENT);
	REGISTER_NS_STRING_CONSTANT("k1", "K1_CONST_STRING", "Hi, const string", CONST_CS | CONST_PERSISTENT);
	REGISTER_NS_DOUBLE_CONSTANT("k1", "K1_CONST_FLOAT", 3.14, CONST_CS | CONST_PERSISTENT);
	REGISTER_NS_BOOL_CONSTANT("k1", "K1_CONST_TRUE", (zend_bool)1, CONST_CS | CONST_PERSISTENT);
	REGISTER_NS_NULL_CONSTANT("k1", "K1_CONST_NULL", CONST_CS | CONST_PERSISTENT);

	return SUCCESS;
}
/* }}} */
```

**PHP Code :**

```php
<?php
echo '\k1\K1_CONST_LONG: ', var_dump(\k1\K1_CONST_LONG);
echo '\k1\K1_CONST_STRING: ', var_dump(\k1\K1_CONST_STRING);
echo '\k1\K1_CONST_FLOAT: ', var_dump(\k1\K1_CONST_FLOAT);
echo '\k1\K1_CONST_TRUE: ', var_dump(\k1\K1_CONST_TRUE);
echo '\k1\K1_CONST_NULL: ', var_dump(\k1\K1_CONST_NULL);
?>
```

**Output :**

```shell
\k1\K1_CONST_LONG: int(110)
\k1\K1_CONST_STRING: string(16) "Hi, const string"
\k1\K1_CONST_FLOAT: float(3.14)
\k1\K1_CONST_TRUE: bool(true)
\k1\K1_CONST_NULL: NULL
```

